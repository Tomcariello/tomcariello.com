<section class="main container-fluid">
  <div class="row">
    <div class="col-md-12">
      <p><a href="/adminportal" class="btn btn-link"><i class="fas fa-arrow-left"></i> Back to Portal</a></p>

      <div class="panel panel-default border-0 shadow-sm">
        <div class="panel-heading bg-dark text-white">
          <h3 class="panel-title puzzle-archive-header">Puzzle Archive Search & Entry</h3>
        </div>
        <div class="panel-body bg-light">
          <div class="row puzzle-search-row">
            <div class="col-md-12">
              <div class="input-group">
                <input type="text" id="adminSearchInput" class="form-control input-lg"
                  placeholder="Search by Puzzle ID (e.g. PZL4190) or Name">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <label class="d-block">&nbsp;</label>
              <button class="btn btn-success btn-lg" onclick="toggleAddForm()">
                <i class="fas fa-plus"></i> Add New Unique Puzzle
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="resultsWrapper" style="display:none;" class="panel panel-default mt-4">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Year</th>
                <th>In Collection</th>
                <th class="text-center">Images</th>
                <th class="text-right">Action</th>
              </tr>
            </thead>
            <tbody id="adminSearchResultsBody">
            </tbody>
          </table>
        </div>
      </div>

      <div id="addNewForm" style="display:none;" class="panel panel-info mt-4">
        <div class="panel-heading"><strong>Create New Archive Entry</strong></div>
        <div class="panel-body">
          <form action="/adminpuzzles/new" method="POST" class="form-horizontal">
            <div class="form-group">
              <label class="col-sm-2 control-label">Puzzle ID</label>
              <div class="col-sm-4">
                <input type="text" name="puzzle_id" class="form-control" placeholder="PZL####" required>
              </div>
              <label class="col-sm-2 control-label">Year</label>
              <div class="col-sm-4">
                <input type="number" name="year" class="form-control" value="1980">
              </div>
            </div>
            <div class="form-group">
              <label class="col-sm-2 control-label">Name</label>
              <div class="col-sm-10">
                <input type="text" name="puzzle_name" class="form-control" required>
              </div>
            </div>
            <div class="text-right">
              <button type="submit" class="btn btn-primary">Create & Proceed to Details</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<script id="puzzleData" type="application/json">{{{json puzzles}}}</script>

<script>
  const allPuzzles = JSON.parse(document.getElementById('puzzleData').innerHTML);
  const searchInput = document.getElementById('adminSearchInput');
  const resultsWrapper = document.getElementById('resultsWrapper');
  const resultsBody = document.getElementById('adminSearchResultsBody');
  const addNewForm = document.getElementById('addNewForm');
  const s3Base = "https://tomcarielloimages.s3.amazonaws.com/puzzle_images/"

  function toggleAddForm() {
    addNewForm.style.display = addNewForm.style.display === 'none' ? 'block' : 'none';
    resultsWrapper.style.display = 'none';
  }

  searchInput.addEventListener('input', (e) => {
    const val = e.target.value.toLowerCase();
    if (val.length < 2) {
      resultsWrapper.style.display = 'none';
      return;
    }

    const matches = allPuzzles.filter(p =>
      p.puzzle_id.toLowerCase().includes(val) ||
      p.puzzle_name.toLowerCase().includes(val)
    ).slice(0, 10); // Only show top 10 matches for speed

    resultsBody.innerHTML = matches.map(p => {
      // Helper to generate a thumb or a placeholder
      const getThumb = (path, label) => path 
        ? `<div class= "admin-thumb-wrapper" > <img src="${s3Base}${path}" title="${label}" class="admin-table-thumb"></div>`
        : `<div class= "admin-thumb-wrapper empty" title = "Missing ${label}" > <i class="fas fa-times"></i></div> `;

      return `
        <tr>
          <td data-label="Name" class="fw-bold">${p.puzzle_name}</td>
          <td data-label="ID">#${p.puzzle_id}</td>
          <td data-label="Year">${p.year}</td>
          <td data-label="Collection">${p.in_collection ? '✅' : '❌'}</td>
          <td data-label="Images" class="text-center">
            <div class="admin-image-strip">
                ${getThumb(p.image_box_front, 'Front')}
                ${getThumb(p.image_box_back, 'Back')}
                    ${getThumb(p.image_complete, 'Complete')}
                </div>
            </td>
            <td class="text-right">
              <a href="/editpuzzle/${p.id}" class="btn btn-sm btn-outline-primary w-100-mobile">
                <i class="fas fa-edit"></i> Edit
              </a>
            </td>
        </tr >`;
      }).join('');

    resultsWrapper.style.display = matches.length > 0 ? 'block' : 'none';
    addNewForm.style.display = 'none';
  });
</script>